<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  <title>nginx,redis,gossip_spider | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="nginx什么是nginx?Nginx是一款高性能的http 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。由俄罗斯的程序设计师Igor Sysoev所开发，官方测试nginx能够支支撑5万并发链接，并且cpu、内存等资源消耗却非常低，运行非常稳定。 为什么要用nginx? 1) http服务器。Nginx是一个http服务可以独立提供http服务。可以做网页静态服务器。 2)">
<meta property="og:type" content="article">
<meta property="og:title" content="nginx,redis,gossip_spider">
<meta property="og:url" content="http://cyannote.github.io.git/娱乐头条-1/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="nginx什么是nginx?Nginx是一款高性能的http 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。由俄罗斯的程序设计师Igor Sysoev所开发，官方测试nginx能够支支撑5万并发链接，并且cpu、内存等资源消耗却非常低，运行非常稳定。 为什么要用nginx? 1) http服务器。Nginx是一个http服务可以独立提供http服务。可以做网页静态服务器。 2)">
<meta property="og:locale" content="zh-cn">
<meta property="og:image" content="d:%5Ctypora%E7%AC%94%E8%AE%B0%5CTypora%E5%9B%BE%E7%89%87%5C1563178753672.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538301333207.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538573149803.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574257790.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1544080592257.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574857793.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574959362.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575008618.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575060321.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575219745.png">
<meta property="og:image" content="f:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1544081473781.png">
<meta property="og:image" content="d:%5Ctypora%E7%AC%94%E8%AE%B0%5CTypora%E5%9B%BE%E7%89%87%5C1541345656514.png">
<meta property="og:updated_time" content="2019-07-21T07:40:52.098Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="nginx,redis,gossip_spider">
<meta name="twitter:description" content="nginx什么是nginx?Nginx是一款高性能的http 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。由俄罗斯的程序设计师Igor Sysoev所开发，官方测试nginx能够支支撑5万并发链接，并且cpu、内存等资源消耗却非常低，运行非常稳定。 为什么要用nginx? 1) http服务器。Nginx是一个http服务可以独立提供http服务。可以做网页静态服务器。 2)">
<meta name="twitter:image" content="d:%5Ctypora%E7%AC%94%E8%AE%B0%5CTypora%E5%9B%BE%E7%89%87%5C1563178753672.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/plugin/bganimation/bg.css">
  

</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <div class="outer">
        <div class="widget-wrap mobile-header">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/source/plugin/img/avatar.jpg">
    <h2 class="author">inverse</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>33</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>0</strong><br>标签</div></a>
    </div>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

        <section id="main"><article id="post-娱乐头条-1" class="wow slideInRight article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/娱乐头条-1/" class="article-date">
  <time class="post-time" datetime="2019-07-21T08:08:51.415Z" itemprop="datePublished">
    <span class="post-month">7月</span><br>
    <span class="post-day">21</span>
  </time>
</a>
   
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      nginx,redis,gossip_spider
    </h1>
  

        <div>
          
          
              

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="nginx"><a href="#nginx" class="headerlink" title="nginx"></a>nginx</h2><h3 id="什么是nginx"><a href="#什么是nginx" class="headerlink" title="什么是nginx?"></a>什么是nginx?</h3><p>Nginx是一款高性能的http 服务器/反向代理服务器及电子邮件（IMAP/POP3）代理服务器。由俄罗斯的程序设计师Igor Sysoev所开发，官方测试nginx能够支支撑5万并发链接，并且cpu、内存等资源消耗却非常低，运行非常稳定。</p>
<h3 id="为什么要用nginx"><a href="#为什么要用nginx" class="headerlink" title="为什么要用nginx?"></a>为什么要用nginx?</h3><ul>
<li>1) <strong>http服务器</strong>。Nginx是一个http服务可以独立提供http服务。可以做网页静态服务器。</li>
<li>2) 虚拟主机。可以实现在一台服务器虚拟出多个网站。例如个人网站使用的虚拟主机。</li>
<li>3) <strong>反向代理，负载均衡</strong>。当网站的访问量达到一定程度后，单台服务器不能满足用户的请求时，需要用多台服务器集群可以使用nginx做反向代理。并且多台服务器可以平均分担负载，不会因为某台服务器负载高宕机而某台服务器闲置的情况。</li>
</ul>
<h3 id="nginx的高可用"><a href="#nginx的高可用" class="headerlink" title="nginx的高可用"></a>nginx的高可用</h3><p>​        负载均衡高可用:为了避免出现nginx出现宕机,可对nginx进行高可用,为nginx提供备用机,使用高可用监控程序(keepalived)来处理,一般的处理模式是,两台同时运行,实际提供服务的只有一台,监控中心与这台服务器之间会传输诸如’I am alive’这样得信息来监控对方的运行状况,一旦发现对方挂掉,就马上切换到另一台,如果挂掉的主服务器重新发送激活的状态 ,监控中心就会将请求交由主服务器</p>
<hr>
<h2 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h2><h3 id="Redis的概念"><a href="#Redis的概念" class="headerlink" title="Redis的概念"></a>Redis的概念</h3><p>​    Redis是一款由C语言编写, 基于内存的持久化的数据库, 其中数据是以KEY-VALUE的形式存储的, Redis提供了丰富的数据类型</p>
<h3 id="Redis的特点"><a href="#Redis的特点" class="headerlink" title="Redis的特点"></a>Redis的特点</h3><ul>
<li>1) Redis将数据存储到内存当中, 所以Redis的读写效率非常高:  读 11w/s  写 8w/s</li>
<li>2) redis提供了丰富的数据类型:  string , hash , list ,set , sortedSet<ul>
<li>注意: redis中数据类型, 主要是描述的key-value中value的数据类型, 而key只有string</li>
</ul>
</li>
<li>3) Redis数据的移植非常快的</li>
<li>4) redis中所有的操作都是原子性的, 保证数据的完整性的</li>
</ul>
<h3 id="redis数据类型的使用场景和特点"><a href="#redis数据类型的使用场景和特点" class="headerlink" title="redis数据类型的使用场景和特点"></a>redis数据类型的使用场景和特点</h3><ul>
<li>string:   可以使用json转换对象, 存储<ul>
<li>特点:  和 java中 string是类似的, 表示的就是字符串</li>
<li>使用场景: 做缓存</li>
</ul>
</li>
<li>hash:  存储对象是比较方便的<ul>
<li>特点: 和 java中 hashMap是类似的</li>
<li>使用场景:  做缓存 (hash使用较少)</li>
</ul>
</li>
<li>list:<ul>
<li>特点:  和 java中 linkedList是类似, 可以看做是队列(FIFO)先进先出</li>
<li>使用场景:  任务队列</li>
</ul>
</li>
<li>set :<ul>
<li>特点:  和 java中set集合是类似的  去重 无序</li>
<li>使用场景: 去重业务</li>
</ul>
</li>
<li>sortedSet<ul>
<li>特点:  和 java中 sortedSet(TreeSet)类型    有序   去重</li>
<li>使用场景:  排序操作(排行榜)</li>
</ul>
</li>
</ul>
<h3 id="jedis连接池"><a href="#jedis连接池" class="headerlink" title="jedis连接池"></a>jedis连接池</h3><p>jedis看做是一个连接对象, 频繁的创建一个连接, 比较耗时耗资源的 通常情况, 采用连接池的技术, 提前的创建好一部分的连接对象, 放置到容器中, 反复的使用即可</p>
<ul>
<li>jedis的连接池基本使用</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JedisUtils</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JedisPool jedisPool;</span><br><span class="line">    <span class="comment">// 什么加载: 随着类的加载而加载, 一般只会加载一次</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        JedisPoolConfig config = <span class="keyword">new</span> JedisPoolConfig();</span><br><span class="line">        config.setMaxTotal(<span class="number">100</span>);  <span class="comment">//最大连接数</span></span><br><span class="line">        config.setMaxIdle(<span class="number">50</span>);   <span class="comment">// 最大闲时的数量</span></span><br><span class="line">        config.setMinIdle(<span class="number">25</span>);   <span class="comment">// 最小闲时的数量</span></span><br><span class="line">      </span><br><span class="line">        jedisPool = <span class="keyword">new</span> JedisPool(config,<span class="string">"192.168.72.142"</span>,<span class="number">6379</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取连接的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Jedis <span class="title">getJedis</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jedisPool.getResource() ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="娱乐爬虫"><a href="#娱乐爬虫" class="headerlink" title="娱乐爬虫"></a>娱乐爬虫</h2><p>163娱乐爬虫流程</p>
<p><img src="D:%5Ctypora%E7%AC%94%E8%AE%B0%5CTypora%E5%9B%BE%E7%89%87%5C1563178753672.png" alt="1563178753672"></p>
<h3 id="1-确定首页url"><a href="#1-确定首页url" class="headerlink" title="1.确定首页url"></a>1.确定首页url</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">News163Spider2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IdWorker idWorker = <span class="keyword">new</span> IdWorker(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NewsDao newsDao = <span class="keyword">new</span> NewsDao();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.确定首页url</span></span><br><span class="line">        List&lt;String&gt; indexUrlList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_index.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_music.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_show.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_tv.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_star.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_movie.js?callback=data_callback"</span>);</span><br></pre></td></tr></table></figure>

<h3 id="2-发送请求-获取数据"><a href="#2-发送请求-获取数据" class="headerlink" title="2.发送请求,获取数据"></a>2.发送请求,获取数据</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">page</span><span class="params">(String indexUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String page = <span class="string">"02"</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//2.发送请求,获取数据</span></span><br><span class="line">            String jsonStr = HttpClientUtils.doGet(indexUrl);</span><br><span class="line">            <span class="keyword">if</span> (jsonStr == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将jsonStr转换为标准json格式</span></span><br><span class="line">            jsonStr = jsonStr.substring(jsonStr.indexOf(<span class="string">"("</span>) + <span class="number">1</span>, jsonStr.lastIndexOf(<span class="string">")"</span>));</span><br><span class="line">            parseJson(jsonStr);</span><br><span class="line">            <span class="comment">//获取下一页url</span></span><br><span class="line"></span><br><span class="line">            indexUrl = indexUrl.replaceAll(<span class="string">"_[0-9]+.js"</span>, <span class="string">".js"</span>);</span><br><span class="line">            String[] split = indexUrl.split(<span class="string">".js"</span>);</span><br><span class="line">            indexUrl = split[<span class="number">0</span>] + <span class="string">"_"</span> + page + <span class="string">".js"</span> + split[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> pagenum = Integer.parseInt(page);</span><br><span class="line">            pagenum ++;</span><br><span class="line">            <span class="keyword">if</span> (pagenum &lt; <span class="number">10</span>)&#123;</span><br><span class="line">                page = <span class="string">"0"</span>+pagenum;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                page = pagenum + <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-解析数据-封装javabean"><a href="#3-解析数据-封装javabean" class="headerlink" title="3.解析数据,封装javabean"></a>3.解析数据,封装javabean</h3><h3 id="4-保存数据-去重"><a href="#4-保存数据-去重" class="headerlink" title="4.保存数据(去重)"></a>4.保存数据(去重)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseJson</span><span class="params">(String jsonStr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//3.解析数据</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; newsList = gson.fromJson(jsonStr, List.class);</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; newsObject : newsList) &#123;</span><br><span class="line">            String docUrl = (String) newsObject.get(<span class="string">"docurl"</span>);</span><br><span class="line">            System.out.println(docUrl);</span><br><span class="line">            <span class="comment">//过滤网页</span></span><br><span class="line">            <span class="keyword">if</span> (!docUrl.contains(<span class="string">"ent.163.com"</span>) || docUrl.contains(<span class="string">"photoview"</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">            Boolean flag = jedis.sismember(<span class="string">"bigData:spider:163News:docUrl02"</span>, docUrl);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line"></span><br><span class="line">            News news = parseNewsItem(docUrl);</span><br><span class="line">            <span class="comment">//4.保存数据</span></span><br><span class="line">            newsDao.saveNews(news);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            jedis.sadd(<span class="string">"bigData:spider:163News:docUrl02"</span>,news.getDocurl());</span><br><span class="line">             jedis.close();</span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//解析新闻详情页  </span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> News <span class="title">parseNewsItem</span><span class="params">(String docUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String html = HttpClientUtils.doGet(docUrl);</span><br><span class="line">        Document document = Jsoup.parse(html);</span><br><span class="line">        News news = <span class="keyword">new</span> News();</span><br><span class="line">        <span class="comment">//获取title</span></span><br><span class="line">        String title = document.select(<span class="string">"#epContentLeft&gt;h1"</span>).text();</span><br><span class="line">        news.setTitle(title);</span><br><span class="line">        <span class="comment">//获取time</span></span><br><span class="line">        String timeAndSource = document.select(<span class="string">".post_time_source"</span>).text();</span><br><span class="line"></span><br><span class="line">        String[] split = timeAndSource.split(<span class="string">"　来源: "</span>);</span><br><span class="line">        String time = split[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        news.setTime(time);</span><br><span class="line">        <span class="comment">//获取source</span></span><br><span class="line">        String source = split[<span class="number">1</span>].substring(<span class="number">0</span>, split[<span class="number">1</span>].indexOf(<span class="string">"举"</span>));</span><br><span class="line">        news.setSource(source);</span><br><span class="line">        <span class="comment">//获取content</span></span><br><span class="line">        String content = document.select(<span class="string">"#endText p"</span>).text();</span><br><span class="line">        news.setContent(content);</span><br><span class="line">        <span class="comment">//获取editor</span></span><br><span class="line">        String editor = document.select(<span class="string">".ep-editor"</span>).text();</span><br><span class="line">        editor = editor.substring(editor.indexOf(<span class="string">"："</span>) + <span class="number">1</span>, editor.indexOf(<span class="string">"_"</span>));</span><br><span class="line">        news.setEditor(editor);</span><br><span class="line">        <span class="comment">//获取id</span></span><br><span class="line">        <span class="keyword">long</span> id = idWorker.nextId();</span><br><span class="line">        news.setId(id + <span class="string">""</span>);</span><br><span class="line">        <span class="comment">//设置docurl</span></span><br><span class="line">        news.setDocurl(docUrl);</span><br><span class="line"><span class="comment">//        System.out.println(news);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回news</span></span><br><span class="line">        <span class="keyword">return</span> news;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="5-分页获取爬取"><a href="#5-分页获取爬取" class="headerlink" title="5.分页获取爬取"></a>5.分页获取爬取</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//5.分页获取数据</span></span><br><span class="line">       <span class="keyword">while</span> (!indexUrlList.isEmpty()) &#123;</span><br><span class="line">           String indexUrl = indexUrlList.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">           page(indexUrl);</span><br><span class="line">           System.out.println(<span class="string">"本栏目爬取完毕!"</span>);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure>

<h3 id="整体爬虫代码"><a href="#整体爬虫代码" class="headerlink" title="整体爬虫代码"></a>整体爬虫代码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">News163Spider2</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IdWorker idWorker = <span class="keyword">new</span> IdWorker(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NewsDao newsDao = <span class="keyword">new</span> NewsDao();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1.确定首页url</span></span><br><span class="line">        List&lt;String&gt; indexUrlList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_index.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_music.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_show.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_tv.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_star.js?callback=data_callback"</span>);</span><br><span class="line">        indexUrlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_movie.js?callback=data_callback"</span>);</span><br><span class="line">        <span class="comment">//5.分页获取数据</span></span><br><span class="line">        <span class="keyword">while</span> (!indexUrlList.isEmpty()) &#123;</span><br><span class="line">            String indexUrl = indexUrlList.remove(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            page(indexUrl);</span><br><span class="line">            System.out.println(<span class="string">"本栏目爬取完毕!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">page</span><span class="params">(String indexUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String page = <span class="string">"02"</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//2.发送请求,获取数据</span></span><br><span class="line">            String jsonStr = HttpClientUtils.doGet(indexUrl);</span><br><span class="line">            <span class="keyword">if</span> (jsonStr == <span class="keyword">null</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//将jsonStr转换为标准json格式</span></span><br><span class="line">            jsonStr = jsonStr.substring(jsonStr.indexOf(<span class="string">"("</span>) + <span class="number">1</span>, jsonStr.lastIndexOf(<span class="string">")"</span>));</span><br><span class="line">            parseJson(jsonStr);</span><br><span class="line">            <span class="comment">//获取下一页url</span></span><br><span class="line">            indexUrl = indexUrl.replaceAll(<span class="string">"_[0-9]+.js"</span>, <span class="string">".js"</span>);</span><br><span class="line">            String[] split = indexUrl.split(<span class="string">".js"</span>);</span><br><span class="line">            indexUrl = split[<span class="number">0</span>] + <span class="string">"_"</span> + page + <span class="string">".js"</span> + split[<span class="number">1</span>];</span><br><span class="line">            <span class="keyword">int</span> pagenum = Integer.parseInt(page);</span><br><span class="line">            pagenum ++;</span><br><span class="line">            <span class="keyword">if</span> (pagenum &lt; <span class="number">10</span>)&#123;</span><br><span class="line">                page = <span class="string">"0"</span>+pagenum;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                page = pagenum + <span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseJson</span><span class="params">(String jsonStr)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//3.解析数据</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; newsList = gson.fromJson(jsonStr, List.class);</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; newsObject : newsList) &#123;</span><br><span class="line">            String docUrl = (String) newsObject.get(<span class="string">"docurl"</span>);</span><br><span class="line">            System.out.println(docUrl);</span><br><span class="line">            <span class="comment">//过滤网页</span></span><br><span class="line">            <span class="keyword">if</span> (!docUrl.contains(<span class="string">"ent.163.com"</span>) || docUrl.contains(<span class="string">"photoview"</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">            Boolean flag = jedis.sismember(<span class="string">"bigData:spider:163News:docUrl02"</span>, docUrl);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">if</span> (flag)&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line"></span><br><span class="line">            News news = parseNewsItem(docUrl);</span><br><span class="line"><span class="comment">//            System.out.println(news);</span></span><br><span class="line">            <span class="comment">//4.保存数据</span></span><br><span class="line">            newsDao.saveNews(news);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            jedis.sadd(<span class="string">"bigData:spider:163News:docUrl02"</span>,news.getDocurl());</span><br><span class="line">             jedis.close();</span><br><span class="line">            <span class="comment">//#########去重########</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> News <span class="title">parseNewsItem</span><span class="params">(String docUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String html = HttpClientUtils.doGet(docUrl);</span><br><span class="line">        Document document = Jsoup.parse(html);</span><br><span class="line">        News news = <span class="keyword">new</span> News();</span><br><span class="line">        <span class="comment">//获取title</span></span><br><span class="line">        String title = document.select(<span class="string">"#epContentLeft&gt;h1"</span>).text();</span><br><span class="line">        news.setTitle(title);</span><br><span class="line">        <span class="comment">//获取time</span></span><br><span class="line">        String timeAndSource = document.select(<span class="string">".post_time_source"</span>).text();</span><br><span class="line"></span><br><span class="line">        String[] split = timeAndSource.split(<span class="string">"　来源: "</span>);</span><br><span class="line">        String time = split[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">        news.setTime(time);</span><br><span class="line">        <span class="comment">//获取source</span></span><br><span class="line">        String source = split[<span class="number">1</span>].substring(<span class="number">0</span>, split[<span class="number">1</span>].indexOf(<span class="string">"举"</span>));</span><br><span class="line">        news.setSource(source);</span><br><span class="line">        <span class="comment">//获取content</span></span><br><span class="line">        String content = document.select(<span class="string">"#endText p"</span>).text();</span><br><span class="line">        news.setContent(content);</span><br><span class="line">        <span class="comment">//获取editor</span></span><br><span class="line">        String editor = document.select(<span class="string">".ep-editor"</span>).text();</span><br><span class="line">        editor = editor.substring(editor.indexOf(<span class="string">"："</span>) + <span class="number">1</span>, editor.indexOf(<span class="string">"_"</span>));</span><br><span class="line">        news.setEditor(editor);</span><br><span class="line">        <span class="comment">//获取id</span></span><br><span class="line">        <span class="keyword">long</span> id = idWorker.nextId();</span><br><span class="line">        news.setId(id + <span class="string">""</span>);</span><br><span class="line">        <span class="comment">//设置docurl</span></span><br><span class="line">        news.setDocurl(docUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回news</span></span><br><span class="line">        <span class="keyword">return</span> news;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="分布式爬虫开发"><a href="#分布式爬虫开发" class="headerlink" title="分布式爬虫开发"></a>分布式爬虫开发</h2><h3 id="1-什么是分布式-分布式和集群的区别"><a href="#1-什么是分布式-分布式和集群的区别" class="headerlink" title="1. 什么是分布式, 分布式和集群的区别"></a>1. 什么是分布式, 分布式和集群的区别</h3><ul>
<li>分布式:  分布式指的就是某一个模块, 或者某个系统, 拆分成不同的业务,并进行分开部署, </li>
<li>集群:     集群更多强调的是将相同的模块或者是系统, 重复部署多次</li>
</ul>
<p>一般来说, 在大多数的情况下, 集群和分布式是同时存在, 共同作用于整个项目</p>
<ul>
<li><p>通俗描述:</p>
<ul>
<li><p>小饭店原来只有一个厨师，切菜洗菜备料炒菜全干。</p>
<p>后来客人多了，厨房一个厨师忙不过来，又请了个厨师，两个厨师都能炒一样的菜，这两个厨师的关系是集群。</p>
<p>为了让厨师专心炒菜，把菜做到极致，又请了个配菜师负责切菜，备菜，备料，厨师和配菜师的关系是分布式。</p>
<p>一个配菜师也忙不过来了，又请了个配菜师，两个配菜师关系是集群。</p>
</li>
</ul>
</li>
<li><p>从刚才的案例中, 请分析出, 集群和分布式能解决什么样的问题?</p>
<ul>
<li>1) 主要解决单节点压力过大  </li>
<li>2) 提高代码的复用性 :   </li>
<li>3) 降低模块间或者各个子系统的耦合性</li>
</ul>
</li>
</ul>
<p>缺点:  提高开发难度</p>
<h3 id="2-进行分布式爬虫编写"><a href="#2-进行分布式爬虫编写" class="headerlink" title="2. 进行分布式爬虫编写"></a>2. 进行分布式爬虫编写</h3><h4 id="2-1-为什么要进行分布式爬虫的改写"><a href="#2-1-为什么要进行分布式爬虫的改写" class="headerlink" title="2.1 为什么要进行分布式爬虫的改写"></a>2.1 为什么要进行分布式爬虫的改写</h4><p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538301333207.png" alt="1538301333207"></p>
<ul>
<li>主要是由于程序的执行效率过低, 可以进行优化提升 </li>
</ul>
<blockquote>
<p>1) 专门用来获取163新闻详情页url程序</p>
<p>2) 专门用来解析163新闻详情页的程序  </p>
<p>3) 专门用来保存数据的程序  (公共的程序)</p>
<p>4) 专门用来获取腾讯新闻数据的程序</p>
</blockquote>
<h4 id="2-2-分布式爬虫的架构"><a href="#2-2-分布式爬虫的架构" class="headerlink" title="2.2 分布式爬虫的架构"></a>2.2 分布式爬虫的架构</h4><p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538573149803.png" alt="1538573149803"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1) 用来执行去重的公共的key:  set</span><br><span class="line">		bigData:spider:docurl  </span><br><span class="line">2) 用来保存详情页docurl的key:  list</span><br><span class="line">		bigData:spider:163itemUrl:docurl</span><br><span class="line">3) 用来保存news对象key :  list</span><br><span class="line">		bigData:spider:newsJson</span><br></pre></td></tr></table></figure>

<h4 id="2-3-分布式爬虫开发"><a href="#2-3-分布式爬虫开发" class="headerlink" title="2.3 分布式爬虫开发:"></a>2.3 分布式爬虫开发:</h4><h5 id="2-3-1-163分布式爬虫改进"><a href="#2-3-1-163分布式爬虫改进" class="headerlink" title="2.3.1 163分布式爬虫改进"></a>2.3.1 163分布式爬虫改进</h5><blockquote>
<p>说明: 163爬虫一共要拆分成三个子工程, 目前将第一个工程命名为News163Master 第二个工程命名为 News163Slave  第三个工程命名为 PublicDaoNode</p>
</blockquote>
<ul>
<li>1) News163Master  开发</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//需求:  获取详情页的url</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1)  确定首页url 2) 发送请求, 获取数据 3) 解析数据 4) 去重判断  5) 将docurl保存到redis中 6) 获取下一页</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">News163Master</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1. 确定首页url:</span></span><br><span class="line">        List&lt;String&gt; urlList = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_index.js?callback=data_callback"</span>);</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_star.js?callback=data_callback"</span>);</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_movie.js?callback=data_callback"</span>);</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_tv.js?callback=data_callback"</span>);</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_show.js?callback=data_callback"</span>);</span><br><span class="line">        urlList.add(<span class="string">"https://ent.163.com/special/000380VU/newsdata_music.js?callback=data_callback"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//5. 分页获取数据</span></span><br><span class="line">        <span class="keyword">while</span>(!urlList.isEmpty()) &#123;</span><br><span class="line">            String indexUrl = urlList.remove(<span class="number">0</span>);</span><br><span class="line">            System.out.println(<span class="string">"获取了下一个栏目的数据#######################################"</span> );</span><br><span class="line">            page(indexUrl);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 执行分页的方法</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">page</span><span class="params">(String indexUrl)</span> <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">        String page = <span class="string">"02"</span>;</span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//1. 发送请求获取数据</span></span><br><span class="line">            <span class="comment">// 此处获取的json的数据, 并不是一个非标准的json</span></span><br><span class="line"></span><br><span class="line">            String jsonStr = HttpClientUtils.doGet(indexUrl);</span><br><span class="line">            <span class="keyword">if</span>(jsonStr==<span class="keyword">null</span>)&#123;</span><br><span class="line">                System.out.println(<span class="string">"数据获取完成"</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 转换为标准json方法</span></span><br><span class="line">            jsonStr = splitJson(jsonStr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2. 解析数据, 3 保存数据</span></span><br><span class="line">            parseJson(jsonStr);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//4. 获取下一页的url</span></span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_index"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_index_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_star"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_star_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_movie"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_movie_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_tv"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_tv_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_show"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_show_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(indexUrl.contains(<span class="string">"newsdata_music"</span>))&#123;</span><br><span class="line">                indexUrl = <span class="string">"https://ent.163.com/special/000380VU/newsdata_music_"</span> + page + <span class="string">".js?callback=data_callback"</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            System.out.println(indexUrl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//5. page ++</span></span><br><span class="line">            <span class="keyword">int</span> pageNum = Integer.parseInt(page);</span><br><span class="line">            pageNum++;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(pageNum &lt;<span class="number">10</span>)&#123;</span><br><span class="line">                page = <span class="string">"0"</span>+pageNum;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                page = pageNum+<span class="string">""</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 解析json的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">parseJson</span><span class="params">(String jsonStr)</span>  <span class="keyword">throws</span>  Exception</span>&#123;</span><br><span class="line">        <span class="comment">//3.1 将json字符串转换成 指定的对象</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line"></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; newsList = gson.fromJson(jsonStr, List.class);</span><br><span class="line">        <span class="comment">// 3.2 遍历整个新闻的结合, 获取每一个新闻的对象</span></span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; newsObj : newsList) &#123;</span><br><span class="line">            <span class="comment">// 新闻 :  标题, 时间,来源 , 内容 , 新闻编辑  ,  新闻的url</span></span><br><span class="line">            <span class="comment">//3.2.1 获取新闻的url , 需要根据url, 获取详情页中新闻数据</span></span><br><span class="line">            String docUrl = (String) newsObj.get(<span class="string">"docurl"</span>);</span><br><span class="line">            <span class="comment">// 过滤掉一些不是新闻数据的url</span></span><br><span class="line">            <span class="keyword">if</span>(docUrl.contains(<span class="string">"photoview"</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(docUrl.contains(<span class="string">"v.163.com"</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(docUrl.contains(<span class="string">"c.m.163.com"</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(docUrl.contains(<span class="string">"dy.163.com"</span>))&#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ###################去重处理代码######################</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">            Boolean flag = jedis.sismember(<span class="string">"bigData:spider:docurl"</span>, docUrl);</span><br><span class="line">            jedis.close();<span class="comment">//一定一定一定不要忘记关闭, 否则用着用着没了, 导致程序卡死不动</span></span><br><span class="line">            <span class="keyword">if</span>(flag)&#123;</span><br><span class="line">                <span class="comment">// 代表存在, 表示已经爬取过了</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ###################去重处理代码######################</span></span><br><span class="line">            <span class="comment">// 将docurl存储到redis的list集合中</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            jedis.lpush(<span class="string">"bigData:spider:163itemUrl:docurl"</span>,docUrl);</span><br><span class="line">            jedis.close();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将非标准的json转换为标准的json字符串</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">splitJson</span><span class="params">(String jsonStr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> firstIndex = jsonStr.indexOf(<span class="string">"("</span>);</span><br><span class="line">        <span class="keyword">int</span> lastIndex = jsonStr.lastIndexOf(<span class="string">")"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jsonStr.substring(firstIndex + <span class="number">1</span>, lastIndex);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>2) News163Slave  开发</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 需求 :  解析新闻详情页的数据</span></span><br><span class="line"><span class="comment">// 步骤:  1) 从redis中获取docurl  2) 根据url解析商品的详情页 3) 封装成news对象  4) 将news对象转换为json数据</span></span><br><span class="line"><span class="comment">//          5) 将newsJson存储到redis的list中  6) 循环</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">News163Slave</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IdWorker idWorker  = <span class="keyword">new</span> IdWorker(<span class="number">0</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//1.从redis中获取docurl</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line"></span><br><span class="line">            <span class="comment">//String docurl = jedis.rpop("bigData:spider:163itemUrl:docurl");  // 取不到的时候出来</span></span><br><span class="line">            <span class="comment">//  第一个参数: 阻塞的时间   如果list中没有数据了, 就会进行阻塞, 最多阻塞20s. 如果在23s之内有数据进来, 马上解除阻塞</span></span><br><span class="line">            <span class="comment">// 返回值:  list    在这个list中只会有两个元素, 第一个元素为key值  第二个元素为弹出的元素</span></span><br><span class="line">            List&lt;String&gt; list = jedis.brpop(<span class="number">20</span>, <span class="string">"bigData:spider:163itemUrl:docurl"</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">if</span>(list == <span class="keyword">null</span> || list.size()==<span class="number">0</span> )&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String docurl = list.get(<span class="number">1</span>);</span><br><span class="line">            <span class="comment">//2. 根据url解析商品的详情页 封装成news对象</span></span><br><span class="line">            News news = parseNewsItem(docurl);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3. 将news对象转换为json数据</span></span><br><span class="line">            Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">            String newsJson = gson.toJson(news);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//4. 将newsJson存储到redis中</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            jedis.lpush(<span class="string">"bigData:spider:newsJson"</span>, newsJson);</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 根据url 解析新闻详情页:</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> News <span class="title">parseNewsItem</span><span class="params">(String docUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        System.out.println(docUrl);</span><br><span class="line">        <span class="comment">//  3.3.1 发送请求, 获取新闻详情页数据</span></span><br><span class="line">        String html = HttpClientUtils.doGet(docUrl);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.3.2 解析新闻详情页:</span></span><br><span class="line">        Document document = Jsoup.parse(html);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.3.2.1 :  解析新闻的标题:</span></span><br><span class="line">        News news = <span class="keyword">new</span> News();</span><br><span class="line">        Elements h1El = document.select(<span class="string">"#epContentLeft h1"</span>);</span><br><span class="line">        String title = h1El.text();</span><br><span class="line">        news.setTitle(title);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.3.2.2 :  解析新闻的时间:</span></span><br><span class="line">        Elements timeAndSourceEl = document.select(<span class="string">".post_time_source"</span>);</span><br><span class="line"></span><br><span class="line">        String timeAndSource = timeAndSourceEl.text();</span><br><span class="line"></span><br><span class="line">        String[] split = timeAndSource.split(<span class="string">"　来源: "</span>);<span class="comment">// 请各位一定一定一定要复制, 否则会切割失败</span></span><br><span class="line">        news.setTime(split[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">//3.3.2.3 :  解析新闻的来源:</span></span><br><span class="line">        news.setSource(split[<span class="number">1</span>]);</span><br><span class="line">        <span class="comment">//3.3.2.4 :  解析新闻的正文:</span></span><br><span class="line">        Elements ps = document.select(<span class="string">"#endText p"</span>);</span><br><span class="line">        String content = ps.text();</span><br><span class="line">        news.setContent(content);</span><br><span class="line">        <span class="comment">//3.3.2.5 :  解析新闻的编辑:</span></span><br><span class="line">        Elements spanEl = document.select(<span class="string">".ep-editor"</span>);</span><br><span class="line">        <span class="comment">// 责任编辑：陈少杰_b6952</span></span><br><span class="line">        String editor = spanEl.text();</span><br><span class="line">        <span class="comment">// 一定要接收返回值, 否则白写了</span></span><br><span class="line">        editor = editor.substring(editor.indexOf(<span class="string">"："</span>) + <span class="number">1</span>, editor.lastIndexOf(<span class="string">"_"</span>));</span><br><span class="line">        news.setEditor(editor);</span><br><span class="line">        <span class="comment">//3.3.2.6 :  解析新闻的url:</span></span><br><span class="line">        news.setDocurl(docUrl);</span><br><span class="line">        <span class="comment">//3.3.2.7: id</span></span><br><span class="line">        <span class="keyword">long</span> id = idWorker.nextId();</span><br><span class="line">        news.setId(id + <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> news;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>3) PublicDaoNode 开发</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 需求 : 公共的保存数据库的程序:</span></span><br><span class="line"><span class="comment">// 步骤:  1) 从redis中获取newsJson数据   2) 将newsJson转换成news对象  3) 去重判断  4) 保存数据</span></span><br><span class="line"><span class="comment">//       5) 将docurl存储到redis的去重的set集合中   6) 循环</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PublicDaoNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> NewsDao newsDao = <span class="keyword">new</span> NewsDao();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="comment">//1) 从redis中获取newsJson数据</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">            List&lt;String&gt; list = jedis.brpop(<span class="number">20</span>, <span class="string">"bigData:spider:newsJson"</span>);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">if</span> (list == <span class="keyword">null</span> || list.size() == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            String newsJson = list.get(<span class="number">1</span>);</span><br><span class="line">            System.out.println(newsJson);</span><br><span class="line">            <span class="comment">//2. 将newsJson转换成news对象</span></span><br><span class="line">            Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">            News news = gson.fromJson(newsJson, News.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">//3) 去重判断</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            Boolean flag = jedis.sismember(<span class="string">"bigData:spider:docurl"</span>, news.getDocurl());</span><br><span class="line">            jedis.close();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//4) 保存数据</span></span><br><span class="line"></span><br><span class="line">            newsDao.saveNews(news);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 5)  将docurl存储到redis的去重的set集合中</span></span><br><span class="line">            jedis = JedisUtils.getJedis();</span><br><span class="line">            jedis.sadd(<span class="string">"bigData:spider:docurl"</span>, news.getDocurl());</span><br><span class="line">            jedis.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="2-2-2-2-腾讯娱乐分布式爬虫改进"><a href="#2-2-2-2-腾讯娱乐分布式爬虫改进" class="headerlink" title="2.2.2.2 腾讯娱乐分布式爬虫改进"></a>2.2.2.2 腾讯娱乐分布式爬虫改进</h5><blockquote>
<p>说明: 腾讯娱乐爬虫需要拆分成二个子工程, 一个子工程用于获取数据,封装news对象, 一个公共的子工程用于保存数据, 其中公共的已经开发完毕, 只需要拆分另一个子工程名为NewsTencentMaster即可</p>
</blockquote>
<ul>
<li>1) NewsTencentMaster 开发</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 需求 :  解析数据, 封装成news对象, 将news对象保存到redis中</span></span><br><span class="line"><span class="comment">//  1) 确定首页url  2) 发送请求, 获取数据  3) 解析数据 4)  去重判断  5) 封装news对象  6) 将news对象转换为newsJson</span></span><br><span class="line"><span class="comment">//  7) 将newsJson保存到Redis中   8) 分页获取</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewsTencentMaster</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> IdWorker idWorker = <span class="keyword">new</span> IdWorker(<span class="number">0</span>,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1. 确定首页url</span></span><br><span class="line">        String topNewsUrl = <span class="string">"https://pacaio.match.qq.com/irs/rcd?cid=137&amp;token=d0f13d594edfc180f5bf6b845456f3ea&amp;ext=ent&amp;num=60"</span>;</span><br><span class="line">        String noTopNewsUrl = <span class="string">"https://pacaio.match.qq.com/irs/rcd?cid=146&amp;token=49cbb2154853ef1a74ff4e53723372ce&amp;ext=ent&amp;page=0"</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 执行分页:</span></span><br><span class="line">        page(topNewsUrl, noTopNewsUrl);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 执行分页的方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">page</span><span class="params">(String topNewsUrl, String noTopNewsUrl)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//1. 热点新闻数据的获取:  只有一页数据</span></span><br><span class="line">        <span class="comment">//1.1 发送请求, 获取数据</span></span><br><span class="line">        String topNewsJsonStr = HttpClientUtils.doGet(topNewsUrl);</span><br><span class="line">        <span class="comment">//1.2 解析数据</span></span><br><span class="line">        List&lt;News&gt; topNewsList = parseJson(topNewsJsonStr);</span><br><span class="line">        <span class="comment">//1.3 保存数据</span></span><br><span class="line">        saveNews(topNewsList);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 处理非热点数据</span></span><br><span class="line">        <span class="keyword">int</span> page = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2.1 发送请求, 获取数据</span></span><br><span class="line">            String noTopNewsJsonStr = HttpClientUtils.doGet(noTopNewsUrl);</span><br><span class="line">            <span class="comment">//2.2 解析数据</span></span><br><span class="line">            List&lt;News&gt; noTopNewsList = parseJson(noTopNewsJsonStr);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (noTopNewsList == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//2.3 保存数据</span></span><br><span class="line">            saveNews(noTopNewsList);</span><br><span class="line">            <span class="comment">//2.4 获取下一页url</span></span><br><span class="line">            noTopNewsUrl = <span class="string">"https://pacaio.match.qq.com/irs/rcd?cid=146&amp;token=49cbb2154853ef1a74ff4e53723372ce&amp;ext=ent&amp;page="</span> + page;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//2.5 自增 +1</span></span><br><span class="line">            page++;</span><br><span class="line"></span><br><span class="line">            System.out.println(page);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 保存数据的操作 : 腾讯返回数据的时候, 就会有重复的数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">saveNews</span><span class="params">(List&lt;News&gt; newsList)</span> </span>&#123;</span><br><span class="line">        Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        <span class="keyword">for</span> (News news : newsList) &#123;</span><br><span class="line">            <span class="comment">// 需要将news对象转换为newsJson</span></span><br><span class="line">            String newsJson = gson.toJson(news);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 将newsJson存储到redis的list集合中</span></span><br><span class="line">            jedis.lpush(<span class="string">"bigData:spider:newsJson"</span>,newsJson);</span><br><span class="line">        &#125;</span><br><span class="line">        jedis.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//  解析新闻数据</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;News&gt; <span class="title">parseJson</span><span class="params">(String newsJsonStr)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//3.1 将字符串json数据转换为指定的类型:   map</span></span><br><span class="line">        Gson gson = <span class="keyword">new</span> Gson();</span><br><span class="line">        Map&lt;String, Object&gt; map = gson.fromJson(newsJsonStr, Map.class);</span><br><span class="line">        <span class="comment">//获取一下, 本次获取了多少条数据</span></span><br><span class="line">        Double datanum = (Double) map.get(<span class="string">"datanum"</span>);</span><br><span class="line">        <span class="keyword">if</span> (datanum.intValue() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//3.2  获取data中数据 : 列表页中数据</span></span><br><span class="line">        List&lt;Map&lt;String, Object&gt;&gt; newsList = (List&lt;Map&lt;String, Object&gt;&gt;) map.get(<span class="string">"data"</span>);</span><br><span class="line">        <span class="comment">//3.3 遍历这个列表, 获取每一个新闻的数据</span></span><br><span class="line">        List&lt;News&gt; tencentNewList = <span class="keyword">new</span> ArrayList&lt;News&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Map&lt;String, Object&gt; newsMap : newsList) &#123;</span><br><span class="line">            String docurl = (String) newsMap.get(<span class="string">"vurl"</span>);</span><br><span class="line">            <span class="keyword">if</span> (docurl.contains(<span class="string">"video"</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//######################去重处理############################33</span></span><br><span class="line">            Jedis jedis = JedisUtils.getJedis();</span><br><span class="line">            Boolean flag = jedis.sismember(<span class="string">"bigData:spider:docurl"</span>, docurl);</span><br><span class="line">            jedis.close();</span><br><span class="line">            <span class="keyword">if</span> (flag) &#123;</span><br><span class="line">                <span class="comment">// 如果为true, 表示已经存在, 已经爬取过了</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//######################去重处理############################33</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">//3.3.1 封装news对象</span></span><br><span class="line">            News news = <span class="keyword">new</span> News();</span><br><span class="line"></span><br><span class="line">            news.setTitle((String) newsMap.get(<span class="string">"title"</span>));</span><br><span class="line">            news.setTime((String) newsMap.get(<span class="string">"update_time"</span>));</span><br><span class="line">            news.setSource((String) newsMap.get(<span class="string">"source"</span>));</span><br><span class="line">            news.setContent((String) newsMap.get(<span class="string">"intro"</span>));</span><br><span class="line">            news.setEditor((String) newsMap.get(<span class="string">"source"</span>));</span><br><span class="line">            news.setDocurl(docurl);</span><br><span class="line"></span><br><span class="line">            news.setId(idWorker.nextId() + <span class="string">""</span>);</span><br><span class="line"></span><br><span class="line">            tencentNewList.add(news);</span><br><span class="line"></span><br><span class="line">            System.out.println(docurl);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> tencentNewList;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意: 开发完成以后., 一定要进行测试:如果能够在本地全部跑通, 才可以进行部署, 否则不要进行部署</p>
</blockquote>
<ul>
<li>测试:<ul>
<li>1) 清空数据: redis  和 mysql</li>
<li>2) 修改一个dao连接内容(修改本地连接)</li>
<li>3) 分别启动四个程序即可: 可以不分先后顺序</li>
</ul>
</li>
</ul>
<h3 id="3-进行分布式爬虫的部署"><a href="#3-进行分布式爬虫的部署" class="headerlink" title="3. 进行分布式爬虫的部署"></a>3. 进行分布式爬虫的部署</h3><h4 id="3-1-部署方案"><a href="#3-1-部署方案" class="headerlink" title="3.1 部署方案"></a>3.1 部署方案</h4><blockquote>
<p>说明: 目前一共有四个子项目, 其中二个master各占用一台虚拟机, 其中一个用来解析新闻详情页, 可以部署一个两台的集群, 其中一个用来保存数据的, 可以部署三台,构建一个集群, 一共为七台, 外加一台mysql和一台redis, 共需要九台服务器</p>
</blockquote>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574257790.png" alt="1538574257790"></p>
<ul>
<li>本次仅仅是模拟部署, 故采用三台服务器来模拟九台服务器:(实际中真实的九台服务器)<ul>
<li>1) 三台服务器都可以上网, 并都安装有jdk1.8以上</li>
<li>2) 三台服务器的防火墙均已关闭(实际中开放端口号)</li>
<li>3) 其中有一台需要安装 MySQL  其中一台安装 Redis,并均已正常开启,mysql必须开启远程登录</li>
</ul>
</li>
</ul>
<h4 id="3-2-部署准备工作"><a href="#3-2-部署准备工作" class="headerlink" title="3.2 部署准备工作"></a>3.2 部署准备工作</h4><ul>
<li><p>1) 检测linux环境:</p>
<ul>
<li>1.1) 使用 ping 命令检测三台是否可以联网,并都安装有jdk1.8<ul>
<li>注意:  Windows电脑上的jdk  和 linux上的jdk需要保持一致</li>
</ul>
</li>
<li>1.2) 使用 service iptables status 查看是否关闭防火墙</li>
<li>1.3) 检测MySQL:<ul>
<li>1.3.1) 在linux中能否正常连接mysql</li>
<li>1.3.2) 在sqlyog中远程连接mysql是否正常</li>
<li>1.3.3) linux和sqlyog连接MySQL的密码需要保持一致, 以免出现存储不进去的问题</li>
</ul>
</li>
<li>1.4)  使用 ps -ef | grep redis  检测redis是否正常启动</li>
</ul>
</li>
<li><p>将项目进行打包:一共有四个子项目, 共需要打包四个jar</p>
<ul>
<li>0) 修改NewsDao中连接数据库相关设置</li>
</ul>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1544080592257.png" alt="1544080592257"></p>
</li>
</ul>
<ul>
<li>1) 添加打包插件:</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--这是jdk编译的插件 --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>utf-8<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!--打包的插件--&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-assembly-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span> <span class="comment">&lt;!-- 注意 此为设置程序的主入口--&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">mainClass</span>&gt;</span>com.cyannote.jdSpider.JdSlave<span class="tag">&lt;/<span class="name">mainClass</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">descriptorRef</span>&gt;</span>jar-with-dependencies<span class="tag">&lt;/<span class="name">descriptorRef</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">descriptorRefs</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>2) 修改打包插件中的主入口:</p>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574857793.png" alt="1538574857793"></p>
</li>
<li><p>3) 将项目进行编译</p>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538574959362.png" alt="1538574959362"></p>
</li>
<li><p>4) 进行打包操作:</p>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575008618.png" alt="1538575008618"></p>
</li>
<li><p>5) 打包成功后, 会在打包过程中提示打包的位置</p>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575060321.png" alt="1538575060321"></p>
</li>
<li><p>6) 打开此位置, 查看此jar包中主入口是否是刚才是设置的主入口类</p>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1538575219745.png" alt="1538575219745"></p>
</li>
<li><p>7) 将其进行更该成对应的jar包的名称后, 放置一个适当的位置等待上传</p>
</li>
<li><p>8) 重复执行以上2~ 7 步, 将四个jar包都要打包出来</p>
<ul>
<li><strong>特别注意: 不要忘记修改主入口类(程序的入口)和 打包前进行编译</strong></li>
</ul>
</li>
</ul>
<p>注意: 需要单独对163slave程序再次进行打包操作. 在导包的时候, 需要修改idwork中编号,否则在部署的时候, 会出现id冲突的问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">因为, IDwork如果编号都一致了, 那么在同一时刻产生的id值是一样的</span><br></pre></td></tr></table></figure>

<h4 id="3-3-进行分布式部署"><a href="#3-3-进行分布式部署" class="headerlink" title="3.3 进行分布式部署"></a>3.3 进行分布式部署</h4><ul>
<li>注意, 在开启这三个服务器连接窗口的时候, 一定要三个一起开</li>
</ul>
<p><img src="F:/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/%E5%A8%B1%E4%B9%90%E5%A4%B4%E6%9D%A1/day05_spider_%E9%83%A8%E7%BD%B2/%E7%AC%94%E8%AE%B0/assets/1544081473781.png" alt="1544081473781"></p>
<blockquote>
<p>使用三台虚拟机模拟9台服务器, 其本质上就是使用xshell 或者 CRT 将三台虚拟机的连接窗口开启各开启三次即可, 然后自己进行分配, 那一台是MySQL, 那一台是Redis, 那一台是master….</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">统一jar包上传至 ; /export/servers/spider 目录下</span><br><span class="line"></span><br><span class="line">mkdir -p /export/servers/spider</span><br><span class="line">rm -rf /export/servers/spider/*</span><br><span class="line">cd /export/servers/spider</span><br></pre></td></tr></table></figure>

<ul>
<li>1) 将对应的jar包上传到 服务器中, 推荐使用 rz进行上传<ul>
<li>将jar包上传至每个服务器的: /export/servers/spider</li>
</ul>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1) 安装 rz 命令:</span><br><span class="line">	安装命令:  yum -y install lrzsz</span><br><span class="line">2) 上传命令:  rz</span><br><span class="line">注意: 上传的位置和输入rz命令的位置是一样的</span><br></pre></td></tr></table></figure>

<ul>
<li>2) 启动各个jar包即可: 推荐先启动获取数据的集群, 后启动 解析数据的集群, 最后启动两个master</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">启动命令:  java -jar  xxx.jar</span><br></pre></td></tr></table></figure>

<hr>
<p>将爬虫设置为定时执行获取数据的操作:  目前采用的shell脚本的方式来操作</p>
<p>需求: 每二十分钟执行一次爬虫程序, 用于爬取最新的新闻信息</p>
<p>实现步骤:</p>
<ul>
<li>1) 更改hosts文件(此步骤需要在每一个centos中配置)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/hosts</span><br><span class="line"></span><br><span class="line">修改如下内容:</span><br><span class="line">192.168.72.141  node01</span><br><span class="line">192.168.72.142  node02</span><br><span class="line">192.168.72.143  node03</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三台服务器必须要配置免密登录</span><br></pre></td></tr></table></figure>

<ul>
<li><p>2) 编写shell脚本:</p>
<blockquote>
<p>注意:  在进行修改shell脚本的时候, 一定要明确, 那台机子上部署了什么jar包</p>
</blockquote>
</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">vi startSpider.sh</span><br><span class="line">i</span><br><span class="line"><span class="meta">#</span>脚本内容:  以下脚本为示例内容, 只提供大体逻辑, 根据实际进行局部修改</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span>!/bin/sh</span><br><span class="line">echo "开始执行"</span><br><span class="line"></span><br><span class="line">for host in node01 node02 node03</span><br><span class="line">do</span><br><span class="line">   ssh -q $host "source /etc/profile; nohup java -jar /export/servers/spider/PublicDaoNode.jar &gt;&gt;/dev/daoLog.log 2&gt;&amp;1 &amp;"</span><br><span class="line">   if [ $host == node01 ]</span><br><span class="line">        then</span><br><span class="line">   ssh -q $host "source /etc/profile; nohup java -jar /export/servers/spider/News163Slave.jar &gt;&gt;/dev/163Slave.log 2&gt;&amp;1 &amp;"</span><br><span class="line">   fi</span><br><span class="line">   if [ $host == node02 ]</span><br><span class="line">        then</span><br><span class="line">   ssh -q $host "source /etc/profile; nohup java -jar /export/servers/spider/News163Slave.jar &gt;&gt;/dev/163Slave.log 2&gt;&amp;1 &amp;"</span><br><span class="line">   fi</span><br><span class="line">   if [ $host == node03 ]</span><br><span class="line">        then</span><br><span class="line">   ssh -q $host "source /etc/profile; nohup java -jar /export/servers/spider/News163Master.jar &gt;&gt;/dev/163Master.log 2&gt;&amp;1 &amp;"</span><br><span class="line">   ssh -q $host "source /etc/profile; nohup java -jar /export/servers/spider/NewsTencentMaster.jar &gt;&gt;/dev/tencent.log 2&gt;&amp;1 &amp;"</span><br><span class="line">   fi</span><br><span class="line">done</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">echo "结束了"</span><br></pre></td></tr></table></figure>

<ul>
<li>3) 编写定时任务: 推荐定时任务和当前shell脚本在同一台虚拟机中</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">crontab -e          // 设置定时, 输入完成后会自动进入一个设置文档中</span><br><span class="line">输入 i  进入编辑模式</span><br><span class="line">*/10 * * * * sh /export/servers/spider/startSpider.sh     // 表示每隔10分钟执行一次 启动爬虫的脚本</span><br><span class="line">输入 esc 退出命令行模式, 输入 :wq  保存退出即可</span><br></pre></td></tr></table></figure>

<p><img src="D:%5Ctypora%E7%AC%94%E8%AE%B0%5CTypora%E5%9B%BE%E7%89%87%5C1541345656514.png" alt></p>
<p><strong>必须修改脚本文件的权限,否则会出现无法启动脚本的情况.</strong></p>
<h3 id="4-使用代理ip"><a href="#4-使用代理ip" class="headerlink" title="4. 使用代理ip"></a>4. 使用代理ip</h3><p><a href="http://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/connmgmt.html#d5e485" target="_blank" rel="noopener">http://hc.apache.org/httpcomponents-client-4.5.x/tutorial/html/connmgmt.html#d5e485</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HttpHost proxy = <span class="keyword">new</span> HttpHost(<span class="string">"someproxy"</span>, <span class="number">8080</span>);</span><br><span class="line">DefaultProxyRoutePlanner routePlanner = <span class="keyword">new</span> DefaultProxyRoutePlanner(proxy);</span><br><span class="line">CloseableHttpClient httpclient = HttpClients.custom()</span><br><span class="line">        .setRoutePlanner(routePlanner)</span><br><span class="line">        .build();</span><br></pre></td></tr></table></figure>

<h4 id="5-3-1-集成在代码中"><a href="#5-3-1-集成在代码中" class="headerlink" title="5.3.1 集成在代码中"></a>5.3.1 集成在代码中</h4><ul>
<li>将代理的ip存放到redis中，存储类型list。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testInitIP</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Jedis conn = JedisUtil.getConn();</span><br><span class="line">		BufferedReader bufferedReader = <span class="keyword">new</span> BufferedReader(</span><br><span class="line">				<span class="keyword">new</span> FileReader(<span class="keyword">new</span> File(<span class="string">"C:\\Users\\maoxiangyi\\Desktop\\Proxies2018-06-06.txt"</span>)));</span><br><span class="line">		String line = <span class="keyword">null</span>;</span><br><span class="line">		<span class="keyword">while</span> ((line=bufferedReader.readLine())!=<span class="keyword">null</span>) &#123;</span><br><span class="line">			conn.lpush(<span class="string">"spider:ip"</span>, line);</span><br><span class="line">		&#125;</span><br><span class="line">		bufferedReader.close();</span><br><span class="line">		conn.close();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>重构后的httpclient</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">execute</span><span class="params">(HttpRequestBase request)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	RequestConfig requestConfig = RequestConfig.custom().setConnectTimeout(<span class="number">5000</span>)<span class="comment">// 设置创建连接的最长时间</span></span><br><span class="line">			.setConnectionRequestTimeout(<span class="number">5000</span>)<span class="comment">// 设置获取连接的最长时间</span></span><br><span class="line">			.setSocketTimeout(<span class="number">10</span> * <span class="number">1000</span>)<span class="comment">// 设置数据传输的最长时间</span></span><br><span class="line">			.build();</span><br><span class="line">	request.setConfig(requestConfig);</span><br><span class="line"></span><br><span class="line">	String html = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 从redis中获取代理IP</span></span><br><span class="line">	Jedis conn = JedisUtil.getConn();</span><br><span class="line">	<span class="comment">// 从右边弹出一个元素之后，从新放回左边</span></span><br><span class="line">	List&lt;String&gt; ipkv = conn.brpop(<span class="number">0</span>, <span class="string">"spider:ip"</span>);</span><br><span class="line">	<span class="comment">// CloseableHttpClient httpClient = getHttpClient();</span></span><br><span class="line">	CloseableHttpClient httpClient = getProxyHttpClient(ipkv.get(<span class="number">1</span>));</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		CloseableHttpResponse res = httpClient.execute(request);</span><br><span class="line">		<span class="keyword">if</span> (<span class="number">200</span> == res.getStatusLine().getStatusCode()) &#123;</span><br><span class="line">			html = EntityUtils.toString(res.getEntity(), Charset.forName(<span class="string">"utf-8"</span>));</span><br><span class="line">			<span class="comment">//请求成功之后，将代理IP放回去，下次继续使用</span></span><br><span class="line">			conn.lpush(<span class="string">"spider:ip"</span>, ipkv.get(<span class="number">1</span>));</span><br><span class="line">			conn.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">		System.out.println(<span class="string">"请求失败"</span>);</span><br><span class="line">		<span class="comment">// TODO 需要开发自动重试功能</span></span><br><span class="line">		<span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> PoolingHttpClientConnectionManager cm;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> CloseableHttpClient <span class="title">getProxyHttpClient</span><span class="params">(String ipkv)</span> </span>&#123;</span><br><span class="line">       </span><br><span class="line">	String[] vals = ipkv.split(<span class="string">":"</span>);</span><br><span class="line">	System.out.println(vals);</span><br><span class="line">	HttpHost proxy = <span class="keyword">new</span> HttpHost(vals[<span class="number">0</span>], Integer.parseInt(vals[<span class="number">1</span>]));</span><br><span class="line">	DefaultProxyRoutePlanner routePlanner = <span class="keyword">new</span> DefaultProxyRoutePlanner(proxy);</span><br><span class="line">	<span class="keyword">return</span> HttpClients.custom().setConnectionManager(connectionManager).setRoutePlanner(routePlanner).build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>




      
    </div>
    <footer class="article-footer">
      <a data-url="http://cyannote.github.io.git/娱乐头条-1/" data-id="cjycojohk000dwo7kf54t50js" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/课堂笔记/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          linux安装
        
      </div>
    </a>
  
  
    <a href="/在Linux-上安装JDK/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">在linux安装JDk</div>
    </a>
  
</nav>

  
</article>



</section>
        
          <aside id="sidebar">
  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <h1 class="blog-title">Hexo</h1>
    <h2 class="blog-subtitle"></h2>
    <ul class="blog-link">
     
          <a href="/" title="Home">
            <li>主页</li>
          </a>
        
          <a href="/archives" title="Archives">
            <li>归档</li>
          </a>
        
          <a href="/categories" title="Categories">
            <li>分类</li>
          </a>
        
          <a href="/tags" title="Tags">
            <li>标签</li>
          </a>
        
    </ul>
  </div>
</div>

  
    <div class="widget-wrap">
  <h3 class="widget-title"></h3>
  <div class="widget">
    <img class="avatar" src="/source/plugin/img/avatar.jpg">
    <h2 class="author">inverse</h2>
    <h3 class="description"></h3>
    <div class="count-box">
      <a href="/archives"><div><strong>33</strong><br>文章</div></a>
      <a href="/categories"><div><strong>0</strong><br>分类</div></a>
      <a href="/tags"><div><strong>0</strong><br>标签</div></a>
    </div>



    <div class="social-link">
      
        <a class="hvr-bounce-in" href="http://github.com/cyannote" target="_blank" title="Github">
          Github
        </a>
      
    </div>

    <div class="friend-link">
      <h2>友情链接</h2>
      
        <a class="hvr-bounce-in" href="http://blog.shanamaid.top/" target="_blank" title="ShanaMaid">
          ShanaMaid
        </a>
      
    </div>
  </div>
</div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy;2018 - 2019 inverse<br>
      由<a href="http://hexo.io/" target="_blank">Hexo</a>强力驱动 | 
      主题-<a href="https://github.com/ShanaMaid/hexo-theme-shana">Shana</a>
      
    </div>
    
  </div>
</footer>
    </div>
    

<script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//apps.bdimg.com/libs/wow/0.1.6/wow.min.js"></script>
<script>
new WOW().init();
</script>   


  <link rel="stylesheet" href="/plugin/fancybox/jquery.fancybox.css">
  <script src="/plugin/fancybox/jquery.fancybox.pack.js"></script>



  <link rel="stylesheet" href="/plugin/galmenu/GalMenu.css">
  <script src="/plugin/galmenu/GalMenu.js"></script>
  <div class="GalMenu GalDropDown">
      <div class="circle" id="gal">
        <div class="ring">
          
            <a href="/" title class="menuItem">首页</a>
          
            <a href="/tags" title class="menuItem">标签</a>
          
            <a href="/categories" title class="menuItem">分类</a>
          
            <a href="/archives" title class="menuItem">归档</a>
          
            <a href="/xxxxxxxxx" title class="menuItem">xxx</a>
          
            <a href="/xxxxxxx" title class="menuItem">xxxx</a>
          
        </div>
        
          <audio id="audio" src="#"></audio>
        
      </div> 
</div>
<div id="overlay" style="opacity: 1; cursor: pointer;"></div>
  <script type="text/javascript">var items = document.querySelectorAll('.menuItem');
    for (var i = 0,
    l = items.length; i < l; i++) {
      items[i].style.left = (50 - 35 * Math.cos( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%";
      items[i].style.top = (50 + 35 * Math.sin( - 0.5 * Math.PI - 2 * (1 / l) * i * Math.PI)).toFixed(4) + "%"
    }</script>
<script type="text/javascript">
  $(document).ready(function() {
    $('body').GalMenu({
      'menu': 'GalDropDown'
    })
  });
</script>

  <section class="hidden-xs"> 
  <ul class="cb-slideshow"> 
    <li><span>苟利</span></li> 
    <li><span>国家</span></li> 
    <li><span>生死以</span></li> 
    <li><span>岂能</span></li> 
    <li><span>祸福</span></li> 
    <li><span>趋避之</span></li> 
  </ul>
</section>
<script src="/js/script.js"></script>



  </div>
</body>
</html>